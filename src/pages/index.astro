---
/* src/pages/index.astro */
---

<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Le Donjon Maudit</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=MedievalSharp&display=swap"
            rel="stylesheet"
        />
        <style is:global>
            @font-face {
                font-family: "Crusades";
                src: url("/fonts/Ozzy II.ttf") format("truetype");
                font-weight: normal;
                font-style: normal;
                font-display: swap;
            }
            body {
                font-family: "MedievalSharp", cursive;
                background-color: #0c0a09;
                min-height: 100vh;
                color: #e7e5e4;
                overflow-x: hidden;
            }
            .bg-layer {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-size: cover;
                background-position: center;
                z-index: -2;
                transition: opacity 0.3s ease-in-out;
                filter: grayscale(100%) brightness(40%) contrast(110%);
            }
            #bg-mort {
                filter: grayscale(20%) brightness(95%) contrast(120%) sepia(30%)
                    hue-rotate(-40deg) !important;
            }
            .vignette-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -1;
                pointer-events: none;
                background: radial-gradient(
                    circle at center,
                    rgba(42, 40, 38, 0) 0%,
                    rgba(12, 10, 9, 0.95) 85%
                );
            }
            .bg-visible {
                opacity: 1 !important;
            }
            .bg-hidden {
                opacity: 0 !important;
            }
            .hidden {
                display: none !important;
            }
            h1,
            h2,
            h3,
            .font-gothic {
                font-family: "Cinzel", serif;
                text-transform: uppercase;
                letter-spacing: 0.1em;
            }
            .font-title {
                font-family: "Crusades", sans-serif;
                letter-spacing: 0.05em;
            }
            .stone-panel,
            .modal-content {
                background-color: rgba(28, 25, 23, 0.9);
                border: 4px double #57534e;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(4px);
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
                border-color: #a8a29e;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
            .animate-fade-in {
                animation: fadeIn 0.5s ease-out forwards;
            }
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 100;
                display: flex;
                justify-content: center;
                align-items: center;
                backdrop-filter: blur(5px);
            }
            .modal-content {
                padding: 2rem;
                border-radius: 0.5rem;
                width: 90%;
                max-width: 400px;
                text-align: center;
            }
            input.gothic-input {
                width: 100%;
                padding: 0.75rem;
                margin-bottom: 1rem;
                background: rgba(0, 0, 0, 0.5);
                border: 2px solid #57534e;
                color: #e7e5e4;
                font-family: "Cinzel", serif;
            }
            input.gothic-input:focus {
                border-color: #d97706;
                outline: none;
            }
            .auth-error {
                color: #ef4444;
                margin-bottom: 1rem;
                font-size: 0.9rem;
            }
            .leaderboard-list {
                text-align: left;
                max-height: 300px;
                overflow-y: auto;
            }
            .leaderboard-item {
                display: flex;
                justify-content: space-between;
                padding: 0.5rem;
                border-bottom: 1px solid #57534e;
            }
            .leaderboard-rank {
                color: #d97706;
                font-weight: bold;
                margin-right: 1rem;
            }
            .shop-btn {
                width: 100%;
                padding: 8px;
                margin-top: 5px;
                border: 1px solid #57534e;
                cursor: pointer;
                transition: all 0.2s;
            }
            .shop-btn:hover:not(:disabled) {
                background: rgba(217, 119, 6, 0.2);
                border-color: #d97706;
            }
            .shop-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .class-owned {
                color: #10b981;
                font-size: 0.8rem;
                margin-top: 5px;
                border: 1px solid #064e3b;
                padding: 4px;
                background: rgba(6, 78, 59, 0.4);
            }
        </style>
    </head>
    <body class="p-4 md:p-8 flex flex-col items-center justify-center">
        <div
            id="bg-door"
            class="bg-layer bg-visible"
            style="background-image: url('/images/porte.png');"
        >
        </div>
        <div
            id="bg-hall"
            class="bg-layer bg-hidden"
            style="background-image: url('/images/hall.png');"
        >
        </div>
        <div
            id="bg-mort"
            class="bg-layer bg-hidden"
            style="background-image: url('/images/mort.png');"
        >
        </div>
        <div class="vignette-overlay"></div>

        <div
            id="auth-widget"
            class="fixed top-4 right-4 z-50 stone-panel p-2 rounded cursor-pointer hover:border-amber-600 transition-colors flex items-center gap-2"
        >
            <span
                id="auth-status-text"
                class="font-gothic text-sm text-amber-500">Login</span
            >
        </div>

        <div id="login-modal" class="modal-overlay hidden">
            <div class="modal-content animate-fade-in">
                <h3 class="text-2xl mb-6 text-amber-600">Connexion</h3><div
                    id="login-error"
                    class="auth-error"
                >
                </div><form id="login-form">
                    <input
                        type="text"
                        name="username"
                        placeholder="Pseudo"
                        class="gothic-input"
                        required
                    /><input
                        type="password"
                        name="password"
                        placeholder="Mot de passe"
                        class="gothic-input"
                        required
                    /><button
                        type="submit"
                        class="font-gothic px-6 py-2 bg-amber-900/80 border-2 border-amber-700 text-amber-100 hover:bg-amber-800 w-full mb-4"
                        >Se connecter</button>
                </form><p class="text-sm text-stone-400">
                    Pas de compte ? <button
                        id="btn-show-register"
                        class="text-amber-500 hover:underline"
                        >S'inscrire</button>
                </p><button
                    class="modal-close absolute top-4 right-4 text-stone-500 hover:text-white"
                    >X</button>
            </div>
        </div>
        <div id="register-modal" class="modal-overlay hidden">
            <div class="modal-content animate-fade-in">
                <h3 class="text-2xl mb-6 text-amber-600">Inscription</h3><div
                    id="register-error"
                    class="auth-error"
                >
                </div><form id="register-form">
                    <input
                        type="text"
                        name="username"
                        placeholder="Pseudo"
                        class="gothic-input"
                        required
                    /><input
                        type="email"
                        name="email"
                        placeholder="Email"
                        class="gothic-input"
                        required
                    /><input
                        type="password"
                        name="password"
                        placeholder="Mot de passe (min 6 chars)"
                        class="gothic-input"
                        required
                        minlength="6"
                    /><button
                        type="submit"
                        class="font-gothic px-6 py-2 bg-amber-900/80 border-2 border-amber-700 text-amber-100 hover:bg-amber-800 w-full mb-4"
                        >Cr√©er le compte</button>
                </form><p class="text-sm text-stone-400">
                    D√©j√† un compte ? <button
                        id="btn-show-login"
                        class="text-amber-500 hover:underline"
                        >Se connecter</button>
                </p><button
                    class="modal-close absolute top-4 right-4 text-stone-500 hover:text-white"
                    >X</button>
            </div>
        </div>
        <div id="leaderboard-modal" class="modal-overlay hidden">
            <div
                class="modal-content animate-fade-in"
                style="max-width: 500px;"
            >
                <h3
                    class="text-2xl mb-6 text-amber-600 font-title tracking-wider"
                >
                    Tableau d'Honneur
                </h3><div id="leaderboard-loading" class="text-stone-400">
                    Chargement des √¢mes...
                </div><div
                    id="leaderboard-container"
                    class="leaderboard-list hidden font-gothic"
                >
                </div><button
                    class="modal-close absolute top-4 right-4 text-stone-500 hover:text-white"
                    >X</button>
            </div>
        </div>

        <game-client></game-client>

        <script>
            import { Game } from "../game/Game.js";
            import { connectGameToUI } from "../gameConnector.js";
            import { uiStore } from "../store.js";
            import {
                authStore,
                initAuth,
                loginSuccess,
                logout,
            } from "../authStore.js";
            import {
                loginUser,
                registerUser,
                saveScoreApi,
                getLeaderboardApi,
                getMyProgressApi,
                claimRewardApi,
                buyHpApi,
                buyClassApi,
            } from "../api.js";

            const game = new Game();
            connectGameToUI();
            initAuth();
            game.init();
            window.game = game;
            window.uiStore = uiStore;
            window.authStore = authStore;

            function createCardHTML(card) {
                let icon = "‚ùì",
                    stats = "",
                    borderColor = "border-stone-600 bg-stone-900/80",
                    iconColor = "text-stone-400",
                    valueColor = "text-stone-100";
                const value = card.effects[0].value;
                if (card.type === "monster") {
                    icon = "üëπ";
                    borderColor =
                        "border-red-900/60 bg-gradient-to-b from-stone-900/90 to-red-950/90";
                    iconColor = "text-red-700";
                    valueColor = "text-red-500";
                    stats = `ATK <span class="font-gothic text-3xl ${valueColor}">${value}</span>`;
                } else if (card.type === "weapon") {
                    icon = "‚öîÔ∏è";
                    borderColor =
                        "border-slate-700 bg-gradient-to-b from-stone-900/90 to-slate-900/90";
                    iconColor = "text-slate-400";
                    valueColor = "text-blue-400";
                    stats = `PWR <span class="font-gothic text-3xl ${valueColor}">${value.power}</span>`;
                } else if (card.type === "potion") {
                    icon = "‚öóÔ∏è";
                    borderColor =
                        "border-emerald-900/60 bg-gradient-to-b from-stone-900/90 to-emerald-950/90";
                    iconColor = "text-emerald-600";
                    valueColor = "text-emerald-400";
                    stats = `HEAL <span class="font-gothic text-3xl ${valueColor}">${value}</span>`;
                }
                return `<div class="${borderColor} w-40 h-60 border-[3px] rounded-md flex flex-col items-center p-2 transition-all duration-300 cursor-pointer shadow-lg relative group select-none backdrop-blur-sm"><div class="text-sm font-bold text-center h-10 flex items-center justify-center w-full border-b border-white/10 font-gothic text-stone-300">${card.name}</div><div class="flex-grow flex items-center justify-center text-6xl drop-shadow-md ${iconColor} opacity-90 group-hover:scale-110 transition-transform">${icon}</div><div class="w-full border-t border-white/10 pt-2 text-center text-xs uppercase tracking-widest text-stone-400">${stats}</div><div class="absolute inset-0 bg-white/0 group-hover:bg-white/5 transition-colors rounded-md"></div></div>`;
            }

            const authWidget = document.getElementById("auth-widget"),
                authStatusText = document.getElementById("auth-status-text"),
                loginModal = document.getElementById("login-modal"),
                registerModal = document.getElementById("register-modal"),
                loginForm = document.getElementById("login-form"),
                registerForm = document.getElementById("register-form"),
                loginError = document.getElementById("login-error"),
                registerError = document.getElementById("register-error"),
                leaderboardContainer = document.getElementById(
                    "leaderboard-container",
                ),
                leaderboardLoading = document.getElementById(
                    "leaderboard-loading",
                );
            window.closeModals = () => {
                loginModal.classList.add("hidden");
                registerModal.classList.add("hidden");
                document
                    .getElementById("leaderboard-modal")
                    .classList.add("hidden");
            };
            window.showLoginModal = () => {
                window.closeModals();
                loginModal.classList.remove("hidden");
                loginError.textContent = "";
            };
            window.showRegisterModal = () => {
                window.closeModals();
                registerModal.classList.remove("hidden");
                registerError.textContent = "";
            };
            window.showLeaderboardModal = async () => {
                window.closeModals();
                document
                    .getElementById("leaderboard-modal")
                    .classList.remove("hidden");
                leaderboardLoading.classList.remove("hidden");
                leaderboardContainer.classList.add("hidden");
                try {
                    const scores = await getLeaderboardApi(10);
                    leaderboardContainer.innerHTML = scores
                        .map(
                            (score, index) =>
                                `<div class="leaderboard-item"><div><span class="leaderboard-rank">#${index + 1}</span> ${score.owner.username}</div><div class="text-amber-500">${score.score_value} pts <span class="text-stone-500 text-xs">(Salle ${score.level_reached})</span></div></div>`,
                        )
                        .join("");
                } catch (e) {
                    leaderboardContainer.innerHTML = `<div class="text-red-500">Erreur de chargement.</div>`;
                } finally {
                    leaderboardLoading.classList.add("hidden");
                    leaderboardContainer.classList.remove("hidden");
                }
            };

            authWidget.addEventListener("click", () => {
                authStore.get().user
                    ? confirm("Se d√©connecter ?") && logout()
                    : window.showLoginModal();
            });
            document
                .querySelectorAll(".modal-close")
                .forEach((btn) =>
                    btn.addEventListener("click", window.closeModals),
                );
            document
                .getElementById("btn-show-register")
                .addEventListener("click", window.showRegisterModal);
            document
                .getElementById("btn-show-login")
                .addEventListener("click", window.showLoginModal);

            window.handleLoginSuccess = async (token, username) => {
                loginSuccess(token, username);
                window.closeModals();
                await loadPlayerProgress();
            };

            window.buyHp = async () => {
                if (!confirm("D√©penser 100 √Çmes pour +1 PV Max ?")) return;
                try {
                    await buyHpApi();
                    await loadPlayerProgress();
                    alert("Vigueur augment√©e !");
                } catch (e) {
                    alert(e.message);
                }
            };
            window.buyClass = async (classId) => {
                if (!confirm(`D√©penser 500 √Çmes pour d√©bloquer ${classId} ?`))
                    return;
                try {
                    await buyClassApi(classId);
                    await loadPlayerProgress();
                    alert(`Classe ${classId} d√©bloqu√©e !`);
                    window.location.reload();
                } catch (e) {
                    alert(e.message);
                }
            };

            async function loadPlayerProgress() {
                if (!authStore.get().user) return;
                try {
                    const progress = await getMyProgressApi();
                    window.game.setPermanentMaxHealth(
                        progress.progression.max_health,
                    );
                    uiStore.setKey("souls", progress.progression.souls || 0);
                    uiStore.setKey(
                        "maxHealth",
                        progress.progression.max_health,
                    );
                    uiStore.setKey(
                        "unlockedClasses",
                        progress.progression.unlocked_classes || [],
                    );
                } catch (e) {
                    console.error(e);
                }
            }

            loginForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(loginForm);
                try {
                    const data = await loginUser(
                        formData.get("username"),
                        formData.get("password"),
                    );
                    window.handleLoginSuccess(
                        data.access_token,
                        formData.get("username"),
                    );
                    loginForm.reset();
                } catch (error) {
                    loginError.textContent = error.message;
                }
            });
            registerForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(registerForm);
                try {
                    await registerUser(
                        formData.get("username"),
                        formData.get("email"),
                        formData.get("password"),
                    );
                    const data = await loginUser(
                        formData.get("username"),
                        formData.get("password"),
                    );
                    window.handleLoginSuccess(
                        data.access_token,
                        formData.get("username"),
                    );
                    registerForm.reset();
                    alert("Compte cr√©√© !");
                } catch (error) {
                    registerError.textContent = error.message;
                }
            });

            authStore.subscribe((state) => {
                if (state.user) {
                    authStatusText.textContent = `üë§ ${state.user.username}`;
                    authStatusText.classList.replace(
                        "text-amber-500",
                        "text-emerald-400",
                    );
                } else {
                    authStatusText.textContent = `Login / Inscription`;
                    authStatusText.classList.replace(
                        "text-emerald-400",
                        "text-amber-500",
                    );
                }
            });
            if (authStore.get().user) loadPlayerProgress();

            class GameClient extends HTMLElement {
                constructor() {
                    super();
                    this.bgDoor = document.getElementById("bg-door");
                    this.bgHall = document.getElementById("bg-hall");
                    this.bgMort = document.getElementById("bg-mort");
                    this.hasSavedScore = false;
                    this.hasClaimedReward = false;

                    // --- CORRECTION MAJEURE ICI ---
                    this.unsubscribeUI = uiStore.subscribe(($store) => {
                        this.updateBackground($store.currentScreen);
                        // On v√©rifie le Game Over √† chaque changement d'√©cran !
                        this.handleGameOverProcesses($store, authStore.get());
                        this.render($store, authStore.get());
                    });

                    this.unsubscribeAuth = authStore.subscribe(($auth) => {
                        this.handleGameOverProcesses(uiStore.get(), $auth);
                        this.render(uiStore.get(), $auth);
                    });
                }

                disconnectedCallback() {
                    this.unsubscribeUI();
                    this.unsubscribeAuth();
                }

                async handleGameOverProcesses($store, $auth) {
                    // Si on n'est pas en Game Over, on reset les flags pour la prochaine fois
                    if ($store.currentScreen !== "GameOver") {
                        this.hasSavedScore = false;
                        this.hasClaimedReward = false;
                        this.rewardMessage = null;
                        return;
                    }

                    // Si on n'est pas connect√©, on ne fait rien
                    if (!$auth.user) return;

                    // 1. Sauvegarde du score
                    if (!this.hasSavedScore && $store.finalScore > 0) {
                        console.log("üíæ [UI] Sauvegarde du score...");
                        this.hasSavedScore = true;
                        try {
                            await saveScoreApi($store.finalScore, $store.level);
                        } catch (e) {
                            console.error(e);
                        }
                    }

                    // 2. R√©clamation de la r√©compense
                    if (!this.hasClaimedReward) {
                        console.log("üéÅ [UI] Demande de r√©compense...");
                        this.hasClaimedReward = true;
                        this.rewardMessage = "Calcul des √¢mes...";
                        this.render($store, $auth);

                        try {
                            const reward = await claimRewardApi(
                                $store.finalScore,
                                $store.level,
                            );
                            console.log("‚ú® [UI] R√©compense re√ßue :", reward);
                            this.rewardMessage = `üîÆ ${reward.message}`;
                            await loadPlayerProgress(); // Met √† jour le compteur d'√¢mes en haut
                        } catch (e) {
                            console.error(e);
                            this.rewardMessage = "Erreur r√©compense";
                            this.hasClaimedReward = false;
                        }
                        this.render($store, $auth);
                    }
                }

                updateBackground(screen) {
                    const setV = (el, vis) => {
                        el.classList.toggle("bg-visible", vis);
                        el.classList.toggle("bg-hidden", !vis);
                    };
                    setV(
                        this.bgDoor,
                        ["MainMenu", "ClassSelection"].includes(screen),
                    );
                    setV(
                        this.bgHall,
                        !["MainMenu", "ClassSelection", "GameOver"].includes(
                            screen,
                        ),
                    );
                    setV(this.bgMort, screen === "GameOver");
                }
                render($store, $auth) {
                    const screens = {
                        Main: $store.currentScreen === "MainMenu",
                        Class: $store.currentScreen === "ClassSelection",
                        Over: $store.currentScreen === "GameOver",
                        Game: ![
                            "MainMenu",
                            "ClassSelection",
                            "GameOver",
                        ].includes($store.currentScreen),
                    };
                    const btnStyle =
                        "font-gothic px-8 py-3 bg-stone-800/90 border-2 border-stone-600 text-stone-300 text-xl hover:bg-stone-700 hover:border-stone-400 hover:text-white transition-all shadow-lg cursor-pointer backdrop-blur-sm";

                    let gameOverHtml = $auth.user
                        ? (this.hasSavedScore
                              ? `<p class="text-emerald-500 mb-4 font-gothic text-sm">Score Sauvegard√©</p>`
                              : "") +
                          (this.rewardMessage
                              ? `<div class="mt-4 p-4 bg-purple-900/40 border border-purple-700 rounded"><p class="text-purple-200 font-gothic text-lg">${this.rewardMessage}</p></div>`
                              : "")
                        : `<button class="${btnStyle}" onclick="window.showLoginModal()">Se connecter</button>`;

                    this.innerHTML = `
                    <div class="${screens.Main ? "" : "hidden"} text-center p-8 max-w-2xl mx-auto mt-10">
                        <h1 class="font-title text-7xl md:text-8xl mb-4 text-stone-200">SCOUNDREL</h1>
                        <div class="w-32 h-1 bg-stone-700 mx-auto mb-12"></div>
                        
                        ${
                            $auth.user
                                ? `
                            <div class="mb-8 p-6 bg-stone-900/80 border-2 border-stone-700 rounded-lg">
                                <div class="flex justify-between items-center mb-4 border-b border-stone-700 pb-2">
                                    <span class="text-purple-400 font-gothic text-xl">üîÆ ${$store.souls} √Çmes</span>
                                    <span class="text-red-400 font-gothic text-xl">‚ù§Ô∏è ${$store.maxHealth} PV</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-left">
                                    <div>
                                        <div class="text-stone-400 text-sm mb-1">Am√©liorations</div>
                                        <button class="shop-btn text-stone-300" onclick="window.buyHp()" ${$store.souls < 100 ? "disabled" : ""}>
                                            +1 PV Max <span class="text-purple-400 float-right">100 üîÆ</span>
                                        </button>
                                    </div>
                                    <div>
                                        <div class="text-stone-400 text-sm mb-1">Classes (500 üîÆ)</div>
                                        ${["warlock", "berserk", "hunter"]
                                            .map((c) => {
                                                const unlocked = (
                                                    $store.unlockedClasses || []
                                                ).includes(c);
                                                if (unlocked) {
                                                    return `<div class="class-owned">‚úÖ ${c.charAt(0).toUpperCase() + c.slice(1)}</div>`;
                                                }
                                                return `<button class="shop-btn text-stone-300" onclick="window.buyClass('${c}')" ${$store.souls < 500 ? "disabled" : ""}>${c.charAt(0).toUpperCase() + c.slice(1)}</button>`;
                                            })
                                            .join("")}
                                    </div>
                                </div>
                            </div>
                        `
                                : ""
                        }

                        <div class="flex flex-col gap-4 items-center">
                            <button class="${btnStyle} text-2xl px-12 py-4 border-4 double" onclick="window.game.currentState.onStartGame()">Entrer dans le Donjon</button>
                            <button class="${btnStyle} text-lg px-8 py-2 border-amber-800 text-amber-500" onclick="window.showLeaderboardModal()">Classement üèÜ</button>
                        </div>
                    </div>

                    <div class="${screens.Class ? "" : "hidden"} text-center p-8 max-w-4xl">
                        <h1 class="text-4xl mb-8 text-stone-200 font-gothic">Destin√©e</h1>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${$store.classChoices.map((c) => `<button class="p-6 bg-stone-900/80 border-2 border-stone-700 text-left hover:border-amber-600 transition-all group relative overflow-hidden cursor-pointer" onclick="window.game.currentState.onSelectClass('${c.id}')"><div class="absolute top-0 left-0 w-1 h-full bg-stone-700 group-hover:bg-amber-600 transition-colors"></div><div class="pl-4"><div class="text-2xl font-gothic text-amber-500 mb-2">${c.name}</div><div class="text-stone-300 text-sm">${c.description}</div></div></button>`).join("")}
                        </div>
                    </div>

                    <div class="${screens.Over ? "" : "hidden"} fixed inset-0 z-50 flex flex-col items-center justify-center text-center backdrop-blur-sm">
                        <h2 class="font-title text-9xl mb-4 text-red-700 tracking-widest scale-y-110">MORT</h2>
                        <div class="mb-8 p-6 border-2 double border-stone-800 bg-stone-950/80 rounded-lg"><span class="text-stone-600 uppercase text-sm">Score</span><br><span class="text-5xl text-amber-600 font-title block">${$store.finalScore}</span></div>
                        ${gameOverHtml}
                        <button class="${btnStyle} mt-8" onclick="window.location.reload()">Nouvelle Vie</button>
                    </div>
                    
                    <div class="${screens.Game ? "" : "hidden"} w-full max-w-5xl">
                        <div class="stone-panel p-4 mb-8 flex flex-col md:flex-row justify-between items-center rounded-lg gap-4">
                            <div class="flex items-center gap-6"><div class="text-center"><div class="text-xs text-stone-500 uppercase">Sant√©</div><div class="text-3xl font-gothic text-red-500">${$store.health} <span class="text-stone-600 text-lg">/ ${$store.maxHealth}</span></div></div><div class="w-px h-10 bg-stone-700 hidden md:block"></div><div class="text-center"><div class="text-xs text-stone-500 uppercase">Arme</div><div class="text-xl font-gothic ${$store.weapon ? "text-blue-400" : "text-stone-600"}">${$store.weapon ? `${$store.weapon.name} (${$store.weapon.power})` : "Mains nues"}</div></div></div>
                            <div class="flex gap-6"><div class="text-right"><div class="text-xs text-stone-500 uppercase">Score</div><div class="text-2xl font-gothic text-amber-500">${$store.score}</div></div><div class="text-right"><div class="text-xs text-stone-500 uppercase">Salle</div><div class="text-2xl font-gothic text-purple-400">${$store.level}</div></div></div>
                        </div>
                        <div class="min-h-[350px] flex items-center justify-center"><div class="flex flex-wrap justify-center gap-6 perspective-1000">${this.renderRoom($store)}</div></div>
                        <div class="mt-12 h-24 flex items-center justify-center gap-4">${this.renderActions($store, btnStyle, btnStyle)}</div>
                    </div>`;
                }
                renderRoom($store) {
                    /* Inchang√© */ if ($store.currentScreen === "RoomDecision")
                        return $store.roomCards
                            .map(
                                (c) =>
                                    `<div class="opacity-40 grayscale scale-90 pointer-events-none">${createCardHTML(c)}</div>`,
                            )
                            .join("");
                    if ($store.currentScreen === "RoomPlaying")
                        return $store.roomCards
                            .map(
                                (c, i) =>
                                    `<div class="card-hover" onclick="window.game.currentState.onSelectCard(window.game.roomAvailableCards[${i}])">${createCardHTML(c)}</div>`,
                            )
                            .join("");
                    if ($store.currentScreen === "WeaponDecision")
                        return `<div class="flex flex-col items-center animate-pulse"><div class="text-red-500 font-gothic text-xl mb-4 tracking-widest">CIBLE VERROUILL√âE</div>${createCardHTML($store.weaponDecision.monster)}</div>`;
                    return "";
                }
                renderActions($store, btn, safe) {
                    /* Inchang√© */ if ($store.currentScreen === "RoomDecision")
                        return `<button class="font-gothic px-8 py-3 border-2 text-lg rounded bg-blue-950/80 border-blue-800 text-blue-200 hover:bg-blue-900" onclick="window.game.currentState.onFlee()" ${$store.isFleeDisabled ? "disabled" : ""}>Fuir</button><button class="font-gothic px-8 py-3 bg-red-950/80 border-2 border-red-800 text-red-100 text-lg rounded hover:bg-red-900" onclick="window.game.currentState.onFight()">COMBATTRE</button>`;
                    if ($store.currentScreen === "RoomPlaying")
                        return `<div class="text-xl text-stone-400 font-gothic bg-black/40 rounded px-4 py-2">Piochez encore <span class="text-stone-200 font-bold">${$store.roomPicksLeft}</span></div>`;
                    if ($store.currentScreen === "WeaponDecision")
                        return `<div class="flex flex-col items-center gap-4 p-6 stone-panel rounded-lg"><p class="text-lg text-stone-300">Utiliser Arme ?</p><div class="flex gap-4"><button class="font-gothic px-6 py-2 bg-emerald-950/80 border-2 border-emerald-800 text-emerald-200" onclick="window.game.currentState.onConfirmWeaponUse(true)">OUI</button><button class="font-gothic px-6 py-2 bg-red-950/80 border-2 border-red-800 text-red-200" onclick="window.game.currentState.onConfirmWeaponUse(false)">NON</button></div></div>`;
                    return "";
                }
            }
            customElements.define("game-client", GameClient);
        </script>
    </body>
</html>
