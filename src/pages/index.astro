---
/* src/pages/index.astro */
---

<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Le Donjon Maudit</title>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=MedievalSharp&display=swap"
            rel="stylesheet"
        />

        <style is:global>
            /* --- IMPORTATION MANUELLE DE LA POLICE CRUSADES --- */
            @font-face {
                font-family: "Crusades";
                src: url("/fonts/Ozzy II.ttf") format("truetype");
                font-weight: normal;
                font-style: normal;
                font-display: swap;
            }

            /* --- CONFIGURATION DU STYLE GLOBAL --- */
            body {
                font-family: "MedievalSharp", cursive;
                background-color: #0c0a09;
                min-height: 100vh;
                color: #e7e5e4;
                overflow-x: hidden;
            }

            /* --- GESTION DES FONDS (IMAGES) --- */
            .bg-layer {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-size: cover;
                background-position: center;
                z-index: -2;
                transition: opacity 0.3s ease-in-out;
                filter: grayscale(100%) brightness(40%) contrast(110%);
            }

            #bg-mort {
                filter: grayscale(20%) brightness(95%) contrast(120%) sepia(30%)
                    hue-rotate(-40deg) !important;
            }

            /* --- LE CALQUE D'AMBIANCE (VIGNETTE) --- */
            .vignette-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -1;
                pointer-events: none;
                background: radial-gradient(
                    circle at center,
                    rgba(42, 40, 38, 0) 0%,
                    rgba(12, 10, 9, 0.95) 85%
                );
            }

            /* Classes utilitaires pour la visibilit√© */
            .bg-visible {
                opacity: 1 !important;
            }
            .bg-hidden {
                opacity: 0 !important;
            }
            .hidden {
                display: none !important;
            }

            /* Styles de textes */
            h1,
            h2,
            h3,
            .font-gothic {
                font-family: "Cinzel", serif;
                text-transform: uppercase;
                letter-spacing: 0.1em;
            }

            .font-title {
                font-family: "Crusades", sans-serif;
                letter-spacing: 0.05em;
            }

            /* Styles des panneaux et boutons */
            .stone-panel,
            .modal-content {
                background-color: rgba(28, 25, 23, 0.9);
                border: 4px double #57534e;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(4px);
            }

            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
                border-color: #a8a29e;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
            .animate-fade-in {
                animation: fadeIn 0.5s ease-out forwards;
            }

            /* --- NOUVEAU : STYLES POUR LES MODALES ET FORMULAIRES --- */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 100;
                display: flex;
                justify-content: center;
                align-items: center;
                backdrop-filter: blur(5px);
            }
            .modal-content {
                padding: 2rem;
                border-radius: 0.5rem;
                width: 90%;
                max-width: 400px;
                text-align: center;
            }
            input.gothic-input {
                width: 100%;
                padding: 0.75rem;
                margin-bottom: 1rem;
                background: rgba(0, 0, 0, 0.5);
                border: 2px solid #57534e;
                color: #e7e5e4;
                font-family: "Cinzel", serif;
            }
            input.gothic-input:focus {
                border-color: #d97706; /* Amber */
                outline: none;
            }
            .auth-error {
                color: #ef4444;
                margin-bottom: 1rem;
                font-size: 0.9rem;
            }

            /* Styles pour le leaderboard */
            .leaderboard-list {
                text-align: left;
                max-height: 300px;
                overflow-y: auto;
            }
            .leaderboard-item {
                display: flex;
                justify-content: space-between;
                padding: 0.5rem;
                border-bottom: 1px solid #57534e;
            }
            .leaderboard-rank {
                color: #d97706;
                font-weight: bold;
                margin-right: 1rem;
            }
        </style>
    </head>
    <body class="p-4 md:p-8 flex flex-col items-center justify-center">
        <div
            id="bg-door"
            class="bg-layer bg-visible"
            style="background-image: url('/images/porte.png');"
        >
        </div>
        <div
            id="bg-hall"
            class="bg-layer bg-hidden"
            style="background-image: url('/images/hall.png');"
        >
        </div>
        <div
            id="bg-mort"
            class="bg-layer bg-hidden"
            style="background-image: url('/images/mort.png');"
        >
        </div>

        <div class="vignette-overlay"></div>

        <div
            id="auth-widget"
            class="fixed top-4 right-4 z-50 stone-panel p-2 rounded cursor-pointer hover:border-amber-600 transition-colors flex items-center gap-2"
        >
            <span
                id="auth-status-text"
                class="font-gothic text-sm text-amber-500">Login</span
            >
        </div>

        <div id="login-modal" class="modal-overlay hidden">
            <div class="modal-content animate-fade-in">
                <h3 class="text-2xl mb-6 text-amber-600">Connexion</h3>
                <div id="login-error" class="auth-error"></div>
                <form id="login-form">
                    <input
                        type="text"
                        name="username"
                        placeholder="Pseudo"
                        class="gothic-input"
                        required
                    />
                    <input
                        type="password"
                        name="password"
                        placeholder="Mot de passe"
                        class="gothic-input"
                        required
                    />
                    <button
                        type="submit"
                        class="font-gothic px-6 py-2 bg-amber-900/80 border-2 border-amber-700 text-amber-100 hover:bg-amber-800 w-full mb-4"
                        >Se connecter</button
                    >
                </form>
                <p class="text-sm text-stone-400">
                    Pas de compte ? <button
                        id="btn-show-register"
                        class="text-amber-500 hover:underline"
                        >S'inscrire</button
                    >
                </p>
                <button
                    class="modal-close absolute top-4 right-4 text-stone-500 hover:text-white"
                    >X</button
                >
            </div>
        </div>

        <div id="register-modal" class="modal-overlay hidden">
            <div class="modal-content animate-fade-in">
                <h3 class="text-2xl mb-6 text-amber-600">Inscription</h3>
                <div id="register-error" class="auth-error"></div>
                <form id="register-form">
                    <input
                        type="text"
                        name="username"
                        placeholder="Pseudo"
                        class="gothic-input"
                        required
                    />
                    <input
                        type="email"
                        name="email"
                        placeholder="Email"
                        class="gothic-input"
                        required
                    />
                    <input
                        type="password"
                        name="password"
                        placeholder="Mot de passe (min 6 chars)"
                        class="gothic-input"
                        required
                        minlength="6"
                    />
                    <button
                        type="submit"
                        class="font-gothic px-6 py-2 bg-amber-900/80 border-2 border-amber-700 text-amber-100 hover:bg-amber-800 w-full mb-4"
                        >Cr√©er le compte</button
                    >
                </form>
                <p class="text-sm text-stone-400">
                    D√©j√† un compte ? <button
                        id="btn-show-login"
                        class="text-amber-500 hover:underline"
                        >Se connecter</button
                    >
                </p>
                <button
                    class="modal-close absolute top-4 right-4 text-stone-500 hover:text-white"
                    >X</button
                >
            </div>
        </div>

        <div id="leaderboard-modal" class="modal-overlay hidden">
            <div
                class="modal-content animate-fade-in"
                style="max-width: 500px;"
            >
                <h3
                    class="text-2xl mb-6 text-amber-600 font-title tracking-wider"
                >
                    Tableau d'Honneur
                </h3>
                <div id="leaderboard-loading" class="text-stone-400">
                    Chargement des √¢mes...
                </div>
                <div
                    id="leaderboard-container"
                    class="leaderboard-list hidden font-gothic"
                >
                </div>
                <button
                    class="modal-close absolute top-4 right-4 text-stone-500 hover:text-white"
                    >X</button
                >
            </div>
        </div>

        <game-client></game-client>

        <script>
            import { Game } from "../game/Game.js";
            import { connectGameToUI } from "../gameConnector.js";
            import { uiStore } from "../store.js";
            // NOUVEAUX IMPORTS
            import {
                authStore,
                initAuth,
                loginSuccess,
                logout,
            } from "../authStore.js";
            import {
                loginUser,
                registerUser,
                saveScoreApi,
                getLeaderboardApi,
                getMyProgressApi,
                claimRewardApi,
            } from "../api.js";

            // --- INITIALISATION ---
            const game = new Game();
            connectGameToUI();
            initAuth(); // V√©rifie si on est d√©j√† connect√© au chargement

            console.log("--- D√âMARRAGE DU DONJON ---");
            game.init();

            window.game = game;
            window.uiStore = uiStore;
            // On expose authStore pour le d√©bug si besoin
            window.authStore = authStore;

            // --- FONCTIONS UTILITAIRES POUR LES CARTES (Inchang√©) ---
            function createCardHTML(card) {
                let icon = "‚ùì";
                let stats = "";
                let borderColor = "border-stone-600 bg-stone-900/80";
                let iconColor = "text-stone-400";
                let valueColor = "text-stone-100";

                const firstEffect = card.effects[0];
                let value = firstEffect.value;

                switch (card.type) {
                    case "monster":
                        icon = "üëπ";
                        borderColor =
                            "border-red-900/60 bg-gradient-to-b from-stone-900/90 to-red-950/90";
                        iconColor = "text-red-700";
                        valueColor = "text-red-500";
                        stats = `ATK <span class="font-gothic text-3xl ${valueColor}">${value}</span>`;
                        break;
                    case "weapon":
                        icon = "‚öîÔ∏è";
                        borderColor =
                            "border-slate-700 bg-gradient-to-b from-stone-900/90 to-slate-900/90";
                        iconColor = "text-slate-400";
                        valueColor = "text-blue-400";
                        stats = `PWR <span class="font-gothic text-3xl ${valueColor}">${value.power}</span>`;
                        break;
                    case "potion":
                        icon = "‚öóÔ∏è";
                        borderColor =
                            "border-emerald-900/60 bg-gradient-to-b from-stone-900/90 to-emerald-950/90";
                        iconColor = "text-emerald-600";
                        valueColor = "text-emerald-400";
                        stats = `HEAL <span class="font-gothic text-3xl ${valueColor}">${value}</span>`;
                        break;
                }

                return `
              <div class="${borderColor} w-40 h-60 border-[3px] rounded-md flex flex-col items-center p-2 transition-all duration-300 cursor-pointer shadow-lg relative group select-none backdrop-blur-sm">
                <div class="text-sm font-bold text-center h-10 flex items-center justify-center w-full border-b border-white/10 font-gothic text-stone-300">
                    ${card.name}
                </div>
                <div class="flex-grow flex items-center justify-center text-6xl drop-shadow-md ${iconColor} opacity-90 group-hover:scale-110 transition-transform">
                    ${icon}
                </div>
                <div class="w-full border-t border-white/10 pt-2 text-center text-xs uppercase tracking-widest text-stone-400">
                    ${stats}
                </div>
                <div class="absolute inset-0 bg-white/0 group-hover:bg-white/5 transition-colors rounded-md"></div>
              </div>
            `;
            }

            // --- LOGIQUE D'AUTHENTIFICATION UI ---
            const authWidget = document.getElementById("auth-widget");
            const authStatusText = document.getElementById("auth-status-text");
            const loginModal = document.getElementById("login-modal");
            const registerModal = document.getElementById("register-modal");
            const loginForm = document.getElementById("login-form");
            const registerForm = document.getElementById("register-form");
            const loginError = document.getElementById("login-error");
            const registerError = document.getElementById("register-error");
            const leaderboardContainer = document.getElementById(
                "leaderboard-container",
            );
            const leaderboardLoading = document.getElementById(
                "leaderboard-loading",
            );

            // Fonctions pour ouvrir/fermer les modales
            window.closeModals = () => {
                loginModal.classList.add("hidden");
                registerModal.classList.add("hidden");
                document
                    .getElementById("leaderboard-modal")
                    .classList.add("hidden");
            };
            window.showLoginModal = () => {
                window.closeModals();
                loginModal.classList.remove("hidden");
                loginError.textContent = "";
            };
            window.showRegisterModal = () => {
                window.closeModals();
                registerModal.classList.remove("hidden");
                registerError.textContent = "";
            };

            // NOUVEAU : Afficher le leaderboard
            window.showLeaderboardModal = async () => {
                window.closeModals();
                document
                    .getElementById("leaderboard-modal")
                    .classList.remove("hidden");
                leaderboardLoading.classList.remove("hidden");
                leaderboardContainer.classList.add("hidden");

                try {
                    const scores = await getLeaderboardApi(10);
                    leaderboardContainer.innerHTML = scores
                        .map(
                            (score, index) => `
                        <div class="leaderboard-item">
                            <div><span class="leaderboard-rank">#${index + 1}</span> ${score.owner.username}</div>
                            <div class="text-amber-500">${score.score_value} pts <span class="text-stone-500 text-xs">(Salle ${score.level_reached})</span></div>
                        </div>
                    `,
                        )
                        .join("");
                } catch (e) {
                    leaderboardContainer.innerHTML = `<div class="text-red-500">Erreur de chargement.</div>`;
                } finally {
                    leaderboardLoading.classList.add("hidden");
                    leaderboardContainer.classList.remove("hidden");
                }
            };

            // Event Listeners pour les interactions UI
            authWidget.addEventListener("click", () => {
                if (authStore.get().user) {
                    // Si connect√©, clic = d√©connexion (pour l'instant)
                    if (confirm("Se d√©connecter ?")) logout();
                } else {
                    window.showLoginModal();
                }
            });

            document
                .querySelectorAll(".modal-close")
                .forEach((btn) =>
                    btn.addEventListener("click", window.closeModals),
                );
            document
                .getElementById("btn-show-register")
                .addEventListener("click", window.showRegisterModal);
            document
                .getElementById("btn-show-login")
                .addEventListener("click", window.showLoginModal);

            // --- LOGIQUE AUTH ---
            // On modifie loginSuccess pour charger la progression d√®s qu'on se connecte
            window.handleLoginSuccess = async (token, username) => {
                loginSuccess(token, username);
                window.closeModals();
                // NOUVEAU : Charger la progression
                await loadPlayerProgress();
            };

            // NOUVELLE FONCTION : Charger la progression depuis le back
            async function loadPlayerProgress() {
                if (!authStore.get().user) return;
                try {
                    console.log("Chargement de la progression...");
                    const progress = await getMyProgressApi();

                    window.game.setPermanentMaxHealth(
                        progress.progression.max_health,
                    );
                    console.log(
                        `Progression charg√©e : ${progress.progression.max_health} PV Max`,
                    );
                } catch (e) {
                    console.error("Erreur chargement progression", e);
                }
            }

            // Gestion du Login
            loginForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                loginError.textContent = "Connexion en cours...";
                const formData = new FormData(loginForm);
                try {
                    const data = await loginUser(
                        formData.get("username"),
                        formData.get("password"),
                    );
                    // Succ√®s ! On utilise la nouvelle fonction handleLoginSuccess
                    window.handleLoginSuccess(
                        data.access_token,
                        formData.get("username"),
                    );
                    loginForm.reset();
                } catch (error) {
                    loginError.textContent = error.message;
                }
            });

            // Gestion de l'Inscription
            registerForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                registerError.textContent = "Cr√©ation en cours...";
                const formData = new FormData(registerForm);
                try {
                    // Inscription r√©ussie
                    await registerUser(
                        formData.get("username"),
                        formData.get("email"),
                        formData.get("password"),
                    );
                    // On connecte automatiquement apr√®s inscription
                    const data = await loginUser(
                        formData.get("username"),
                        formData.get("password"),
                    );
                    window.handleLoginSuccess(
                        data.access_token,
                        formData.get("username"),
                    );
                    registerForm.reset();
                    alert(
                        "Compte cr√©√© avec succ√®s ! Bienvenue dans le donjon.",
                    );
                } catch (error) {
                    registerError.textContent = error.message;
                }
            });

            // Mise √† jour du widget en fonction de l'√©tat du store
            authStore.subscribe((state) => {
                if (state.user) {
                    authStatusText.textContent = `üë§ ${state.user.username}`;
                    authStatusText.classList.remove("text-amber-500");
                    authStatusText.classList.add("text-emerald-400");
                } else {
                    authStatusText.textContent = `Login / Inscription`;
                    authStatusText.classList.remove("text-emerald-400");
                    authStatusText.classList.add("text-amber-500");
                }
            });

            // NOUVEAU : Si on est d√©j√† connect√© au chargement de la page, on charge la progression
            if (authStore.get().user) {
                loadPlayerProgress();
            }

            // --- WEB COMPONENT DU JEU (Modifi√© pour g√©rer l'auth) ---
            class GameClient extends HTMLElement {
                constructor() {
                    super();
                    this.bgDoor = document.getElementById("bg-door");
                    this.bgHall = document.getElementById("bg-hall");
                    this.bgMort = document.getElementById("bg-mort");
                    this.hasSavedScore = false;
                    this.hasClaimedReward = false; // NOUVEAU FLAG pour la r√©compense

                    // On s'abonne aux DEUX stores maintenant
                    this.unsubscribeUI = uiStore.subscribe(($store) => {
                        this.updateBackground($store.currentScreen);
                        // On passe aussi l'√©tat d'auth au render
                        this.render($store, authStore.get());
                    });
                    this.unsubscribeAuth = authStore.subscribe(($auth) => {
                        // Si l'auth change, on re-rend le jeu aussi
                        this.handleGameOverProcesses(uiStore.get(), $auth);
                        this.render(uiStore.get(), $auth);
                    });
                }

                disconnectedCallback() {
                    this.unsubscribeUI();
                    this.unsubscribeAuth();
                }

                // NOUVEAU : Gestion compl√®te de la fin de partie (Sauvegarde + R√©compense)
                async handleGameOverProcesses($store, $auth) {
                    if ($store.currentScreen !== "GameOver" || !$auth.user) {
                        // Reset des flags si on quitte l'√©cran
                        if ($store.currentScreen !== "GameOver") {
                            this.hasSavedScore = false;
                            this.hasClaimedReward = false;
                            this.rewardMessage = null; // Pour stocker le message √† afficher
                        }
                        return;
                    }

                    // 1. Sauvegarde du score (Si pas d√©j√† fait et score > 0)
                    if (!this.hasSavedScore && $store.finalScore > 0) {
                        this.hasSavedScore = true;
                        try {
                            await saveScoreApi($store.finalScore, $store.level);
                            console.log("Score sauvegard√©.");
                        } catch (e) {
                            console.error("Erreur score:", e);
                        }
                    }

                    // 2. R√©clamation de la r√©compense (Si pas d√©j√† fait)
                    if (!this.hasClaimedReward) {
                        this.hasClaimedReward = true;
                        this.rewardMessage = "Ouverture du coffre..."; // Message temporaire
                        this.render($store, $auth); // Force le rendu pour afficher le message

                        try {
                            console.log("R√©clamation de la r√©compense...");
                            const reward = await claimRewardApi();
                            this.rewardMessage = `üéÅ ${reward.message}`;
                            console.log("R√©compense obtenue :", reward);

                            // Recharger la progression pour la prochaine partie
                            await loadPlayerProgress();
                        } catch (e) {
                            console.error("Erreur r√©compense:", e);
                            this.rewardMessage =
                                "Impossible d'obtenir la r√©compense.";
                            this.hasClaimedReward = false; // Autorise √† r√©essayer
                        }
                        this.render($store, $auth); // Force le rendu final
                    }
                }

                // ... (updateBackground est inchang√©) ...
                updateBackground(screen) {
                    const setVisibility = (element, makeVisible) => {
                        if (makeVisible) {
                            element.classList.remove("bg-hidden");
                            element.classList.add("bg-visible");
                        } else {
                            element.classList.remove("bg-visible");
                            element.classList.add("bg-hidden");
                        }
                    };
                    if (screen === "GameOver") {
                        setVisibility(this.bgDoor, false);
                        setVisibility(this.bgHall, false);
                        setVisibility(this.bgMort, true);
                    } else if (
                        ["MainMenu", "ClassSelection"].includes(screen)
                    ) {
                        setVisibility(this.bgDoor, true);
                        setVisibility(this.bgHall, false);
                        setVisibility(this.bgMort, false);
                    } else {
                        setVisibility(this.bgDoor, false);
                        setVisibility(this.bgHall, true);
                        setVisibility(this.bgMort, false);
                    }
                }

                // ‚úÖ MODIFICATION : render prend maintenant $auth en argument
                render($store, $auth) {
                    const showMainMenu =
                        $store.currentScreen === "MainMenu" ? "" : "hidden";
                    const showClassSelect =
                        $store.currentScreen === "ClassSelection"
                            ? ""
                            : "hidden";
                    const showGameOver =
                        $store.currentScreen === "GameOver" ? "" : "hidden";
                    const showGameContainer = ![
                        "MainMenu",
                        "ClassSelection",
                        "GameOver",
                    ].includes($store.currentScreen)
                        ? ""
                        : "hidden";

                    const btnStyle =
                        "font-gothic px-8 py-3 bg-stone-800/90 border-2 border-stone-600 text-stone-300 text-xl hover:bg-stone-700 hover:border-stone-400 hover:text-white transition-all shadow-lg active:transform active:scale-95 cursor-pointer backdrop-blur-sm";
                    const btnDanger =
                        "font-gothic px-6 py-2 bg-red-950/80 border-2 border-red-800 text-red-200 hover:bg-red-900 hover:text-white transition-all cursor-pointer backdrop-blur-sm";
                    const btnSafe =
                        "font-gothic px-6 py-2 bg-emerald-950/80 border-2 border-emerald-800 text-emerald-200 hover:bg-emerald-900 hover:text-white transition-all cursor-pointer backdrop-blur-sm";

                    // Logique Game Over mise √† jour pour afficher la r√©compense
                    let gameOverHtml = "";
                    if ($auth.user) {
                        // Si on a un message de r√©compense, on l'affiche
                        const rewardHtml = this.rewardMessage
                            ? `<div class="mt-4 p-4 bg-amber-900/40 border border-amber-700 rounded animate-fade-in">
                                <p class="text-amber-200 font-gothic text-lg">${this.rewardMessage}</p>
                            </div>`
                            : "";

                        gameOverHtml = this.hasSavedScore
                            ? `<p class="text-emerald-500 mb-4 font-gothic text-sm">Score enregistr√© dans les annales !</p>${rewardHtml}`
                            : `<p class="text-stone-500 mb-4 font-gothic text-sm animate-pulse">Traitement de fin de partie...</p>`;
                    } else {
                        gameOverHtml = `<p class="text-amber-500 mb-4 font-gothic text-sm">Connectez-vous pour sauvegarder !</p>
                            <div class="flex gap-4 justify-center"><button class="${btnStyle} border-amber-600 text-amber-200" onclick="window.showLoginModal()">Se connecter</button></div>`;
                    }

                    this.innerHTML = `
                    <div id="main-menu-screen" class="${showMainMenu} text-center p-8 max-w-2xl mx-auto mt-10">
                        <h1 class="font-title text-7xl md:text-8xl mb-4 text-stone-200 drop-shadow-2xl tracking-wide">SCOUNDREL</h1>
                        <div class="w-32 h-1 bg-stone-700 mx-auto mb-12"></div>
                        <p class="text-xl text-stone-300 mb-12 italic drop-shadow-md">"Oserez-vous franchir le seuil ?"</p>
                         <div class="flex flex-col gap-4 items-center">
                            <button class="${btnStyle} text-2xl px-12 py-4 border-4 double" onclick="window.game.currentState.onStartGame()">Entrer dans le Donjon</button>
                            <button class="${btnStyle} text-lg px-8 py-2 border-amber-800 text-amber-500" onclick="window.showLeaderboardModal()">Voir le Classement üèÜ</button>
                        </div>
                    </div>

                    <div id="class-selection-screen" class="${showClassSelect} text-center p-8 w-full max-w-4xl">
                        <h1 class="text-4xl mb-8 text-stone-200 font-gothic drop-shadow-lg">Choisissez votre Destin√©e</h1>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             ${$store.classChoices
                                 .map(
                                     (classDef) => `
                                <button class="p-6 bg-stone-900/80 border-2 border-stone-700 text-left hover:border-amber-600 hover:bg-stone-800/90 transition-all group relative overflow-hidden cursor-pointer backdrop-blur-md"
                                        onclick="window.game.currentState.onSelectClass('${classDef.id}')">
                                    <div class="absolute top-0 left-0 w-1 h-full bg-stone-700 group-hover:bg-amber-600 transition-colors"></div>
                                    <div class="pl-4">
                                        <div class="text-2xl font-gothic text-amber-500 mb-2">${classDef.name}</div>
                                        <div class="text-stone-300 text-sm leading-relaxed">${classDef.description}</div>
                                    </div>
                                </button>
                            `,
                                 )
                                 .join("")}
                        </div>
                    </div>

                    <div id="game-over-screen" class="${showGameOver} fixed inset-0 z-50 flex flex-col items-center justify-center text-center animate-fade-in backdrop-blur-sm">
                        <h2 class="font-title text-8xl md:text-9xl mb-4 text-red-700 drop-shadow-[0_0_25px_rgba(185,28,28,0.6)] tracking-widest scale-y-110">MORT</h2>
                        <p class="text-3xl mb-8 text-stone-500 font-gothic drop-shadow-md">Votre √¢me rejoint le n√©ant.</p>
                        <div class="mb-8 p-6 border-2 double border-stone-800 bg-stone-950/80 rounded-lg shadow-2xl backdrop-blur-md">
                            <span class="text-stone-600 uppercase text-sm tracking-[0.3em]">Score Final</span><br>
                            <span class="text-5xl text-amber-600 font-title mt-2 block">${$store.finalScore}</span>
                        </div>
                        ${gameOverHtml}
                          <button class="${btnStyle} mt-8" onclick="window.game.currentState.onRestartGame()">Tenter une nouvelle vie</button>
                    </div>
                    
                    <div id="game-container" class="${showGameContainer} w-full max-w-5xl">
                        <div class="stone-panel p-4 mb-8 flex flex-col md:flex-row justify-between items-center rounded-sm border-y-4 border-x-0 md:border-4 md:rounded-lg gap-4">
                            <div class="flex items-center gap-6">
                                <div class="text-center">
                                    <div class="text-xs text-stone-500 uppercase tracking-wider">Sant√©</div>
                                    <div class="text-3xl font-gothic text-red-500 drop-shadow-sm">
                                        ${$store.health} <span class="text-stone-600 text-lg">/ ${$store.maxHealth}</span>
                                    </div>
                                </div>
                                <div class="w-px h-10 bg-stone-700 hidden md:block"></div>
                                <div class="text-center">
                                    <div class="text-xs text-stone-500 uppercase tracking-wider">Arme</div>
                                    <div class="text-xl font-gothic ${$store.weapon ? "text-blue-400" : "text-stone-600"}">
                                        ${$store.weapon ? `${$store.weapon.name} (${$store.weapon.power})` : "Mains nues"}
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-6">
                                <div class="text-right">
                                    <div class="text-xs text-stone-500 uppercase">Score</div>
                                    <div class="text-2xl font-gothic text-amber-500">${$store.score}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-stone-500 uppercase">Salle</div>
                                    <div class="text-2xl font-gothic text-purple-400">${$store.level}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="min-h-[350px] flex items-center justify-center">
                            <div class="flex flex-wrap justify-center gap-6 perspective-1000">
                                ${this.renderRoom($store)}
                            </div>
                        </div>
                        
                        <div class="mt-12 h-24 flex items-center justify-center gap-4">
                             ${this.renderActions($store, btnDanger, btnSafe)}
                        </div>
                    </div>
                `;
                }
                // ... (renderRoom et renderActions sont inchang√©s, je ne les remets pas pour gagner de la place mais ils doivent √™tre l√† !) ...
                renderRoom($store) {
                    if (
                        $store.currentScreen === "WeaponDecision" &&
                        !$store.weaponDecision
                    )
                        return "";
                    if ($store.currentScreen === "RoomDecision") {
                        return $store.roomCards
                            .map(
                                (c) =>
                                    `<div class="opacity-40 grayscale scale-90 pointer-events-none">${createCardHTML(c)}</div>`,
                            )
                            .join("");
                    }
                    if ($store.currentScreen === "RoomPlaying") {
                        return $store.roomCards
                            .map((card, index) => {
                                return `<div class="card-hover" onclick="window.game.currentState.onSelectCard(window.game.roomAvailableCards[${index}])">${createCardHTML(card)}</div>`;
                            })
                            .join("");
                    }
                    if ($store.currentScreen === "WeaponDecision") {
                        return `<div class="flex flex-col items-center animate-pulse"><div class="text-red-500 font-gothic text-xl mb-4 tracking-widest drop-shadow-md">CIBLE VERROUILL√âE</div>${createCardHTML($store.weaponDecision.monster)}</div>`;
                    }
                    return "";
                }
                renderActions($store, btnDanger, btnSafe) {
                    if ($store.currentScreen === "RoomDecision") {
                        const fleeClass = $store.isFleeDisabled
                            ? "opacity-50 cursor-not-allowed bg-stone-800 text-stone-600 border-stone-700"
                            : "bg-blue-950/80 border-blue-800 text-blue-200 hover:bg-blue-900 hover:text-white hover:border-blue-500 cursor-pointer backdrop-blur-sm";
                        return `<button class="font-gothic px-8 py-3 border-2 text-lg rounded transition-all ${fleeClass}" ${$store.isFleeDisabled ? "disabled" : ""} onclick="window.game.currentState.onFlee()">${$store.isFleeDisabled ? "Fuite Impossible" : "Fuir la salle"}</button><button class="font-gothic px-8 py-3 bg-red-950/80 border-2 border-red-800 text-red-100 text-lg rounded hover:bg-red-900 hover:border-red-500 hover:text-white hover:scale-105 transition-all shadow-lg shadow-red-900/20 cursor-pointer backdrop-blur-sm" onclick="window.game.currentState.onFight()">COMBATTRE</button>`;
                    }
                    if ($store.currentScreen === "RoomPlaying") {
                        return `<div class="text-xl text-stone-400 font-gothic border-b-2 border-stone-800 pb-2 px-8 drop-shadow-md bg-black/40 rounded">Choisissez encore <span class="text-stone-200 font-bold">${$store.roomPicksLeft}</span> carte${$store.roomPicksLeft > 1 ? "s" : ""}</div>`;
                    }
                    if (
                        $store.currentScreen === "WeaponDecision" &&
                        $store.weaponDecision
                    ) {
                        return `<div class="flex flex-col items-center gap-4 p-6 stone-panel rounded-lg"><p class="text-lg text-stone-300">Utiliser <span class="text-blue-400 font-bold">${$store.weaponDecision.weapon.name}</span> ?</p><div class="flex gap-4"><button class="${btnSafe}" onclick="window.game.currentState.onConfirmWeaponUse(true)">OUI (Attaque)</button><button class="${btnDanger}" onclick="window.game.currentState.onConfirmWeaponUse(false)">NON (Mains nues)</button></div></div>`;
                    }
                    return "";
                }
            }

            customElements.define("game-client", GameClient);
        </script>
    </body>
</html>
